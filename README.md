# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом
- src/components/common/ - папка с общими компонентами Form и Modal
- src/components/model/ - папка с классами моделей данных
- src/components/view/ - папка с классами отображения
- src/types - папка с типами данных
- src/utils - папка с набором утилит

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types — Директория с типами
- src/components/application.ts - класс Application - реализующий бизнес логику приложения
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Архитекрута

В качестве основы для реализации данного приложения была выбрана архитектура Model-View-Presenter. Диаграмма представленная ниже отображает процессы взаимодействия между архитектурными слоями приложения.

Слой `Model` реализует хранилище данных для всего приложения, а также предоставляет методы для управления этими данными или выборки. При обновлении моделей данных генериются события, которые обрабатываются в слое `Presenter`.

Слой `View` реализует визуальные компоненты для отображения данных из моделей и взаимодействия с пользователем. При выполнении каких-либо действий пользователем генерируются события, которые обрабатываются в слое `Presenter`.

Слой `Presenter` является связующим звеном между слоями `Model` и `View`, в данном слое реализуется все функции бизнес логики:
- Получение данных из моделей
- Управление данными в моделях через предоставляемые методы
- Обработка событий пользователя
- Обработка событий изменений в моделях данных
- Перерисовка компонентов пользовательского интерфейса
- Управление состоянием приложения

UML диаграмма архитектуры расположена в корневой директории проекта в директории `diagrams`

![UML диаграмма архитектуры](./diagrams/architecture-diagram.png)

## Модели данных (MODEL)

### Проектирование

Для слоя `Model` были спроектированы интерфейсы сущностей, API клиентов для работы с сервером, а также моделей состояний данных.

#### Сущности приложения

**1. Интерфейс `IProduct`** - сущность товара

```ts
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number;
}
```

**2. Интерфейс `IOrder`** - сущность заказа

```ts
export interface IOrder {
  payment: string;
  email: string;
  phone: string;
  address: string;
  total: number;
  items: Array<string>;
}
```

**3. Интерфейс `IOrderResult`** - сущность результата созданного заказа

```ts
export interface IOrderResult {
  id: string
  total: number
}
```

#### API интерфейсы

Для работы с внешним источником данных (REST API сервером) спроектированы интерфейсы API клиентов `IProductAPI` и `IOrderApi`

Интерфейс `IProductApi` описывает методы:
- `getProducts` - получение коллекции всех товаров, хранящихся на сервере
- `getProduct` - получение одного товара по уникальному аттрибуту `id`

Интерфейс `IOrderApi` описывает методы:
- `createOrder` - создания нового заказа на сервере

#### Модели данных

Для хранения и управления данными в приложении был спроектирован набор интерфейсов, описывающих слой `Model`.

Интерфейс `ICatalogModel` агрегирует коллекцию каталога товаров, а также методы для работы с коллекцией:
- `products` - хранит коллекцию товаров
- `setProducts` - метод установки коллекции товаров
- `getProduct` - метод, для получение одного товара из коллекции по атрибуту `id`

Интерфейс `IBasketModel` описывает свойства и методы для работы с моделью корзины товаров:
- `hasProduct` - метод, проверяющий наличие товара в корзине
- `addProduct` - метод, для добавления товара в корзину, принимает аргумент типа `IProduct`
- `removeProduct` - метод, для удаления товара из корзины по идентификатору
- `getTotal` - метод, для получения общего количества товаров в корзине
- `getTotalPrice` - метод для расчёта общей стоимости корзины товаров
- `getProducts` - метод для получения списка товаров добавленных в корзину, возвращает коллекцию объектов `IProduct`
- `clear` - метод, для очистки всей корзины, может быть использован после того как заказ оформлен

Интерфейс `IOrderModel` агрегирует информацию пользователя, необходимую для создания заказа:
- `buyer` - интерфейс `IBuyerInfo` описывает данные необходимые для создания заказа (способ оплаты, адрес доставки, email и телефон).
- `changeBuyerField` - метод для обновления полей объекта `buyer`. Принимает аргументы `key`  - поле для обновления и `value` - обновлённое значение.
- `reset` - метод, для очисти данных о покупателе, может быть использован после того как заказ создан.

```ts
export interface IBuyerInfo {
  payment: PaymentType | null
  address: string
  email: string
  phone: string
}
```

### Реализация

#### API клиенты

**1. Класс `ProductApi`**

Реализует API клиент для работы с товарами. Класс наследуется от базового класса `Api`, а также реализует интерфейс `IProductApi`.

Конструктор принимает такие аргументы:
- `cdnUrl` - адрес CDN сервера
- `baseUrl` - базовый адрес для доступа к REST API
- `options` - объект с настройками API клиента

Класс имеет такие методы:
- `prepareProductItem` - принимает объект типа `IProduct` и преобразует значение свойства `image` в нём
- `getProducts` - выполняет `GET` запрос по адресу `{baseUrl}/product`. Возвращает тип `Promise` с коллекцией объектов типа `IProduct`.
- `getProduct` - принимает параметр `id` - идентификатор товара и выполняет `GET` запрос по адресу `{baseUrl}/product/{id}`. Возвращает тип `Promise` с объектом товара типа `IProduct` или `null` если товар не найден на сервере.


**2. Класс `OrderApi`**

Реализует API клиент для работы с заказами. Класс наследуется от базового класса `Api`, а также реализует интерфейс `IOrderApi`.

Класс имеет такие методы:
- `createOrder` - принимает объект типа `IOrder` и выполняет `POST` запрос для создания нового заказа. Возвращает тип `Promise` c объектом типа `IOrderResult`.

#### Модели данных

**1. Класс `Model`**

Абстрактный базовый класс модели данных. Конструктор класса принимает аргумент `events` типа `IEvents`.

Класс имеет такие методы:
- `changed` - принимает аргумент `event` текстовое значение события и опциональный аргумент `data` типа `T`. Генерирует событие через объект `events`.

**2. Класс `BasketModel`**

Реализует модель состояния корзины. Хранение заказов в данной модели организовано с помощью структуры `Map<string, IProduct>` для удобного хранения, добавления и удаления заказов.

Класс имеет такие методы:
- `updateBasket` - генерирует событие типа `BasketUpdateEvent` при любом изменении внутреннего состояния корзины. Метод является приватным.
- `hasProduct` - проверяет был ли добавлен товар в корзину, вовзращет значение типа `boolean`
- `addProduct` - добавляет товар в модель корзины, принимает объект типа `IProduct`
- `removeProduct` - удаляет товар из модели корзины по идентификатору
- `getTotal` - возвращает количество товаров в корзине
- `getTotalPrice` - вычисляет общую стоимость всех добавленных в корзину товаров
- `getProducts` - возвращает коллекцию товаров `Array<IProduct>` хранящихся в корзине
- `clear` - очищает корзину товаров

**3. Класс `CatalogModel`**

Реализует модель каталога товаров.

Конструктор принимает аргументы:
- `events` - экземпляр класса реализующего интерфейс `IEvents`
- `productApi` - экземпляр класса реализующего интерфейс `IProductApi`

Класс реализует методы:
- `products` - возвращает коллекцию объектов типа `IProduct`, хранящихся в модели
- `loadProducts` - загружает данные о товарах с сервера и сохраняет во внутреннем состоянии модели
- `getProduct` - производит поиск в коллекции товаров по идентификатору `id`

**4. Класс `OrderModel`**

Реализует модель создания заказа. Агрегирует информацию о заказе в объекте `buyer` типа `IBuyerInfo`.

Конструктор принимает аргументы:
- `events` - экземпляр класса реализующего интерфейс `IEvents`
- `orderApi` - экземпляр класса реализующего интерфейс `IOrderApi`

Класс реализует методы:
- `changeBuyerField<K extends keyof IBuyerInfo>` - изменяет значение объекта данных о заказе по ключу `key` типа `K`
- `reset` - очищает объект данных о заказе
- `createOrder` - создаёт новый заказ на сервере

## Компоненты отображения (VIEW)

### Проектирование

Для описания слоя отображения данных был спроектирован набор интерфейсов базовых компонентов:

- `IComponent<T extends HTMLElement, D extends object, S>` - дженерик интерфейс базового компонента, описывает метод `render` для отрисовки компонента
- `IModal` - интерфейс описывающий методы компонента модального окна, расширяет интерфейс `IComponent`
- `IForm` - интерфейс описывающий методы компонента формы, расширяет интерфейс `IComponent`

В директории `src/types/view` также были описаны интерфейсы данных и настроек компонентов отображения:

- `PageData` - описывает данные необходимые для отображения галереии товаров и счётчика корзины товаров
- `BasketData` - описывает данные необходимые для отображения корзины товаров
- `CardBasketData` - описывает данные необходимые для отображения одного элемента карточки товара в корзине
- `CardCatalogData` - описывает данные необходимые для отображения одного элемента карточки товара в каталоге всех товаров
- `CardPreviewData` - описывает данные необходимые для превью выделенной карточки товара
- `ContactsData` - описывает данные необходимые для отображения email и телефона при создании заказа
- `OrderData` - описывает данные необходимые для отображения способа оплаты и адреса доставки при создании заказа
- `SuccessData` - описывает данные необходимые для отображения после успешного офрмления заказа

### Реализация

Для спроектированных интерфейсов были реализованы классы базовых компоненетов, на основе которых строятся все компоненты отображения данных.

#### Базовые компоненты

**1. Класс `Component<T, D, S>`**

Базовый абстрактный класс, который является основой для всех компонентов интерфейса, реализует методы интерфейса `IComponent`.
Класс является дженериком и принимает следующие аргументы:
- `T` - тип HTML элемента данного компонента, является производным от типа `HTMLElement`
- `D` - тип данных, которые принимает метод `render` для отрисовки компонента
- `S` - тип с настройками компонента

Конструктор класса помечен свойством `protected`, поэтому должен быть явно определён в наследуемых классах. Конструктор принимает такие аргументы:
- `events` - экземпляр класса реализующего интерфейс `IEvents`, необходим для генерации событий в компонентах
- `container` - HTML элемент компонента
- `settings` - опциональный параметр с настройками компонента

Класс имеет такие методы:
- `render` - принимает аргумент типа `D` для отрисовки данных в компоненте и возвращает значение типа `T`. Метод является абстрактным и должен быть реализован в наследуемых классах. В наследуемых классах данный метод определяет отрисовку данных для конкретного компонента.
- `setText` - принимает 2 парметра (`element` и `text`) и устанавливает значение свойства `textContent` для элемента. Метод является защищённым и может быть использован в наследуемых классах.
- `setImage` - принимает элемент типа `HTMLImageElement` и устанавливает ссылку на изображение для элемента. Метод является защищённым и может быть использован в наследуемых классах.

**2. Класс `Modal`**

Компонент модального окна, наследуется от базового класса `Component<HTMLDivElement, ModalData, ModalSettings>`, а также реализует методы интерфейса `IModal`.

Класс имеет такие методы:
- `setContent` - принимает аргумент `content` типа `HTMLElement` и устанавливает содержимое, которое должно быть отрисовано в модальном окне
- `open` - отображает компонент модального окна
- `close` - скрывает компонент модального окна
- `render` - отрисовывает компонент и содержимое модального окна

**3. Класс `Form<D, S>`**

Абстрактный класс формы, реализующий базовый функционал для всех наследуемых классов. Класс наследуется от базового класса `Component<HTMLFormElement, FormData<D>, FormSettings<S>>`, а также реализует методы интерфейса `IForm`.
В конструкторе класса происходит поиск всех компонентов текстовых полей и их маппинг по имени в структуруру типа `Map<string, HTMLInputElement>`.

Класс имеет такие методы:
- `onSubmit` - обработчик отправки формы. Метод является абстрактным и должен быть определён в наследуемых классах.
- `onInputChange` - обработчик изменения значения в текстовом поле. Метод является абстрактным и должен быть определён в наследуемых классах.
- `setError` - устанавливает текстовое описание элемента ошибки в форме
- `setValid` - изменяет состояние элемента кнопки отправки формы
- `render` - принимает дженерик аргумент `FormData<D>` и устанавливает значение элемента ошибки в форме и изменяет состояние кнопки отправки формы

#### Компоненты отображения

Помимо базовых классов также был реализован набор классов для непосредственного отображения данных:

- `PageComponent` - компонент главной страницы, хранит ссылку на контейнер для отрисовки списка карточек товаров, а также элемент корзины товаров
- `BasketComponent` - компонент для отображения добавленных в корзину товаров
- `CardComponent` - компонент, который содержит общие элементы для карточки товара
- `CardBasketComponent` - компонент карточки товара добавленного в корзину. Наследуется от `CardComponent`.
- `CardCatalogComponent` - компонент карточки товара, отображаемой в галерее. Наследуется от `CardComponent`.
- `CardPreviewComponent` - компонент карточки товара, отображаемого в модальном окне. Наследуется от `CardComponent`.
- `OrderForm` - компонент формы, для выбора способа платежа и указания адреса доставки
- `ContactsForm` - компонент формы, для указания контактных данных
- `SuccessComponent` - компонент подтверждения оформленного заказа

Экземпляры классов большинства всех реализованных View компонентов создаются во время инициализации приложения, кроме компонентов `CardBasket` и `CardCatalog`.
Данные экземпляры должны создаваться динамически во время отрисовки галерии или корзины товаров

UML диаграмма классов расположенна в корневой директории проекта в директории `diagrams`.

![UML диаграмма](diagrams/class-diagram.png)

## Компоненты представления и бизнес-логики (Presenter)

### Проектирование

Слой `Presenter` описывается интерфейсом `IApplication`, который объединяет интерфейсы отображений и моделей данных, а также декларирует какие методы и обработчики событий должны быть реализованы в классе.

```ts
export interface IApplication {
  // модели
  basketModel: IBasketModel
  catalogModel: ICatalogModel
  orderModel: IOrderModel

  // компонент страницы
  page: IPage;

  // модальные компоненты
  modal: IModal;
  modalComponents: ModalComponentsMap;

  // валидаторы
  orderValidator: IFormValidator<OrderData>;
  contactsValidator: IFormValidator<ContactsData>;

  init: () => void
  openBasket: () => void
  updateBasketCounter: (count: number) => void
  updateCatalog: (evt: CatalogUpdateEvent) => void
  updateBasket: (evt: BasketUpdateEvent) => void
  updateBuyerInfo: (evt: BuyerInfoUpdateEvent) => void
  selectProduct: (evt: ProductEvent) => void
  addProductToBasket: (evt: ProductEvent) => void
  removeProductFromBasket: (evt: ProductEvent) => void
  createOrder: () => void
  closeModal: () => void
}
```

Перечисления (enum) событий были описаны в файле `src/types/events.ts`

```ts
export enum ModelEvents {
  CatalogUpdated = 'model:catalog-updated',
  BasketUpdated = 'model:basket-updated',
  BuyerInfoUpdated = 'model:buyer-info-updated'
}
```

```ts
export enum UIEvents {
  ModalClose = 'ui:modal-close',
  ProductSelect = 'ui:product-select',
  BasketAddProduct = 'ui:basket-add',
  BasketRemoveProduct = 'ui:basket-remove',
  BasketOpen = 'ui:basket-open',
  BasketCreateOrder = 'ui:basket-create-order',
  OrderFormChanged = 'ui:order-form-changed',
  OrderFormCompleted = 'ui:order-form-completed',
  ContactsFormChanged = 'ui:contacts-form-changed',
  ContactsFormCompleted = 'ui:contacts-form-completed',
  SuccessOrder = 'ui:success-order'
}
```

Помимо перечислений событий, также описаны интерфейсы для нужных событий:

- `CatalogUpdateEvent` - событие генерируемое при изменении модели данных катагола
- `BasketUpdateEvent` - событие генерируемое при изменении модели корзины товаров
- `BuyerInfoUpdateEvent` - событие генерируеме при изменении данных для создания заказа
- `ProductEvent` - событие генерируемое при выделение карточки товара, добавлении или удалении из корзины
- `FormFieldChangeEvent<T>` - событие генерируемое при изменении полей формы

### Реализация

**Класс `Application`**

Реализуя интерфейс `IApplication` данный класс по сути представляет глобальное состояние всего приложение, а также связывает компоненты слоёв `View` и `Model` посредством обработки событий и перерисовки компонентов.

Конструктор принимает аргумент `events` типа `IEvents`.


Класс реализует свойства:
- `basketModel` - модель корзины товаров
- `catalogModel` - модель каталого товаров
- `orderModel` - модель заказа товаров
- `page` - компонент основной страницы приложения
- `modal` - компонент корневого модального окна
- `modalComponents` - структура данных `ключ:значение`, где ключём является название компонента, а значением сам объект компонента. Используется для удобства отрисовки содержимого модального окна.
- `orderValidator` - валидатор данных `OrderData`
- `contactsValidator` - валидатор данных `ContactsData`


Класс реализует методы:
- метод `init` - устанавливает обработчики событий и загружает коллекцию товаров через модель `catalogModel`
- метод `openBasket` - обрабатывает событие открытия корзины
- метод `updateBasketCounter` - обновляет счётчик корзины товаров
- метод `updateCatalog` - обработчик события `CatalogUpdateEvent`, генерируемого в слое `Model`. При срабатывании данного события происходит перерисовка корзины товаров.
- метод `updateBasket` - обработчик события `BasketUpdateEvent`, генерируемого в слое `Model`. При срабатывании данного события происходит обновление счётчика товаров, а также перерисовывается компонент корзины товаров в модальном окне, в случае если оно активно.
- метод `updateBuyerInfo` - обработчик события `BuyerInfoUpdated`, генерируемого в слое `Model`. При срабатывании данного события происходит онбволения компонента `OrderForm` или `ContactsForm` в зависимости от активного состояния модального окна.
- метод `selectProduct` - обработчик события `ProductEvent`, генерируемого в слое `View` при нажатии на карточку товара. После выбора карточки будет получено полное описание объекта `IProduct` из модели `CatalogModel` и отображен компонент `preview` в модальном окне.
- метод `addProductToBasket` - обработчик события `ProductEvent`, генерируемого в слое `View` при добавлении товара в корзину.
- метод `removeProductFromBasket` - обработчик события `ProductEvent`, генерируемого в слое `View` при удалении товара из корзины.
- метод `closeModal` - обработчик события закрытия модального окна


Так как класс `Application` является многосоставным, для создания экземпляров данного класса был реализован класс `ApplicationBuilder`, который позволяет поэтапно конструировать объекты типа `IApplication`.
Класс `ApplicationBuilder` реализует паттерн `Builder`. Класс реализует методы:
- `constructor` - создание нового экземпляра класса `Application` внутри объекта `ApplicationBuilder`
- `setModels` - установка необходимых моделей данных для экземпляра класса `Application`
- `setPages` - установка компонента страницы для экземпляра класса `Application`
- `setModals` - установка компонентов модальных страниц для экземпляра класса `Application`
- `setValidators` - установка валидаторов форм для экземпляра класса `Application`
- `build` - получение экземпляра класса `Application`

Инициализация всех необходимых компонентов моделей и отображений, а также создание экземпляра класса `Application` происходит в файле `src/index.ts`.
